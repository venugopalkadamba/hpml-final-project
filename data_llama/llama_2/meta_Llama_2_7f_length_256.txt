python3 -m torch.distributed.run --nproc_per_node=4          llama2/LightSeq/lightseq/twp_v1.py         --model_name_or_path meta-llama/Llama-2-7b-hf         --data_path data_llama2.pkl        --bf16         --output_dir outputs         --num_train_epochs 3            --per_device_train_batch_size 1         --per_device_eval_batch_size 1          --gradient_accumulation_steps 1         --evaluation_strategy no         --save_strategy steps         --save_steps 1000          --save_total_limit 1         --learning_rate 2e-5         --weight_decay 0.          --warmup_ratio 0.03          --lr_scheduler_type "cosine"         --logging_steps 1          --fsdp "full_shard auto_wrap"         --fsdp_transformer_layer_cls_to_wrap 'LlamaDecoderLayer'         --tf32 True          --model_max_length 256          --gradient_checkpointing True          --lazy_preprocess True > meta_Llama_2_1B_length_256.txt


Initializing Torch distributed.
************ Finish sequence pralell group Initialization. ***********
trainable params 6738415616
trainable params 6738415616
torch distributed is already initialized, skipping initialization ...
trainable params 6738415616
trainable params 6738415616
Initializing global memoery buffer.
Initializing global memoery buffer for backward.
Cumulated time list [18.357395887374878]Cumulated time list [18.357385635375977]Cumulated time list [18.357393264770508]


Cumulated time list [18.358842611312866]
Cumulated time list [18.358842611312866, 18.78290891647339]Cumulated time list [18.357395887374878, 18.78422999382019]Cumulated time list [18.357393264770508, 18.784247636795044]


Cumulated time list [18.357385635375977, 18.78438091278076]
Cumulated time list [18.357395887374878, 18.78422999382019, 18.782889127731323]Cumulated time list [18.357393264770508, 18.784247636795044, 18.78290891647339]

Cumulated time list [18.358842611312866, 18.78290891647339, 18.782939672470093]
Cumulated time list [18.357385635375977, 18.78438091278076, 18.782907247543335]
Cumulated time list [18.357395887374878, 18.78422999382019, 18.782889127731323, 18.77075457572937]Cumulated time list [18.357393264770508, 18.784247636795044, 18.78290891647339, 18.770785331726074]

Cumulated time list [18.357385635375977, 18.78438091278076, 18.782907247543335, 18.77099919319153]
Cumulated time list [18.358842611312866, 18.78290891647339, 18.782939672470093, 18.774484634399414]
Cumulated time list [18.357393264770508, 18.784247636795044, 18.78290891647339, 18.770785331726074, 18.77040410041809]
Cumulated time list [18.358842611312866, 18.78290891647339, 18.782939672470093, 18.774484634399414, 18.766767263412476]
Cumulated time list [18.357385635375977, 18.78438091278076, 18.782907247543335, 18.77099919319153, 18.770402193069458]
Cumulated time list [18.357395887374878, 18.78422999382019, 18.782889127731323, 18.77075457572937, 18.7723867893219]
Cumulated time list [18.357393264770508, 18.784247636795044, 18.78290891647339, 18.770785331726074, 18.77040410041809, 18.777780532836914]Cumulated time list [18.357385635375977, 18.78438091278076, 18.782907247543335, 18.77099919319153, 18.770402193069458, 18.777534246444702]

Cumulated time list [18.358842611312866, 18.78290891647339, 18.782939672470093, 18.774484634399414, 18.766767263412476, 18.77782702445984]
Cumulated time list [18.357395887374878, 18.78422999382019, 18.782889127731323, 18.77075457572937, 18.7723867893219, 18.77950382232666]
Cumulated time list [18.357395887374878, 18.78422999382019, 18.782889127731323, 18.77075457572937, 18.7723867893219, 18.77950382232666, 18.78274393081665]
Cumulated time list [18.358842611312866, 18.78290891647339, 18.782939672470093, 18.774484634399414, 18.766767263412476, 18.77782702445984, 18.78658628463745]
Cumulated time list [18.357385635375977, 18.78438091278076, 18.782907247543335, 18.77099919319153, 18.770402193069458, 18.777534246444702, 18.786834716796875]
Cumulated time list [18.357393264770508, 18.784247636795044, 18.78290891647339, 18.770785331726074, 18.77040410041809, 18.777780532836914, 18.787686586380005]
Cumulated time list [18.357393264770508, 18.784247636795044, 18.78290891647339, 18.770785331726074, 18.77040410041809, 18.777780532836914, 18.787686586380005, 18.77807879447937]
Cumulated time list [18.357385635375977, 18.78438091278076, 18.782907247543335, 18.77099919319153, 18.770402193069458, 18.777534246444702, 18.786834716796875, 18.778987884521484]
Cumulated time list [18.358842611312866, 18.78290891647339, 18.782939672470093, 18.774484634399414, 18.766767263412476, 18.77782702445984, 18.78658628463745, 18.779125928878784]
Cumulated time list [18.357395887374878, 18.78422999382019, 18.782889127731323, 18.77075457572937, 18.7723867893219, 18.77950382232666, 18.78274393081665, 18.78336787223816]
Cumulated time list [18.357393264770508, 18.784247636795044, 18.78290891647339, 18.770785331726074, 18.77040410041809, 18.777780532836914, 18.787686586380005, 18.77807879447937, 18.779446840286255]Cumulated time list [18.357385635375977, 18.78438091278076, 18.782907247543335, 18.77099919319153, 18.770402193069458, 18.777534246444702, 18.786834716796875, 18.778987884521484, 18.779449701309204]Cumulated time list [18.357395887374878, 18.78422999382019, 18.782889127731323, 18.77075457572937, 18.7723867893219, 18.77950382232666, 18.78274393081665, 18.78336787223816, 18.775389909744263]


Cumulated time list [18.358842611312866, 18.78290891647339, 18.782939672470093, 18.774484634399414, 18.766767263412476, 18.77782702445984, 18.78658628463745, 18.779125928878784, 18.781412601470947]
Per GPU shape: torch.Size([1, 256]), 18732.073545455933 ms, 132.55262275745199 ms
Per GPU shape: torch.Size([1, 256]), 18732.097970114814 ms, 132.5838763405205 ms
Per GPU shape: torch.Size([1, 256]), 18732.32165972392 ms, 132.15648019520742 ms
Per GPU shape: torch.Size([1, 256]), 18732.081333796184 ms, 132.58212037958373 ms
-------------------------------------------------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  
                                                   Name    Self CPU %      Self CPU   CPU total %     CPU total  CPU time avg     Self CUDA   Self CUDA %    CUDA total  CUDA time avg       CPU Mem  Self CPU Mem      CUDA Mem  Self CUDA Mem    # of Calls  
-------------------------------------------------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  
                                     record_param_comms         0.14%     461.998ms         0.24%     775.325ms      60.384us      178.097s        37.18%      183.219s      14.269ms           0 b           0 b           0 b           0 b         12840  
autograd::engine::evaluate_function: CheckpointFunct...         0.00%      11.912ms        41.65%      137.278s     428.993ms       0.000us         0.00%      164.447s     513.898ms           0 b           0 b      29.24 Gb      -1.86 Gb           320  
        CheckpointFunctionEndWithFlashAttentionBackward         0.30%     983.391ms        41.65%      137.266s     428.956ms        2.102s         0.44%      164.447s     513.898ms           0 b     -10.00 Kb      31.09 Gb     -10.29 Gb           320  
                       FullyShardedDataParallel.forward         0.26%     842.656ms        29.58%       97.483s      75.568ms       0.000us         0.00%      158.100s     122.558ms       1.60 Mb           8 b      23.49 Gb     -43.65 Gb          1290  
                                 c10d::_allgather_base_         0.01%      36.529ms         0.15%     504.035ms     261.158us       0.000us         0.00%      133.922s      69.390ms           0 b           0 b           0 b           0 b          1930  
ncclDevKernel_AllGather_RING_LL(ncclDevComm*, unsign...         0.00%       0.000us         0.00%       0.000us       0.000us      132.070s        27.57%      132.070s      68.430ms           0 b           0 b           0 b           0 b          1930  
                                  nccl:_all_gather_base         0.00%       0.000us         0.00%       0.000us       0.000us      132.070s        27.57%      132.070s      68.430ms           0 b           0 b           0 b           0 b          1930  
                  FullyShardedDataParallel._pre_forward         0.33%        1.101s        12.69%       41.838s      32.433ms       0.000us         0.00%       89.830s      69.635ms           0 b           0 b     487.40 Gb     487.40 Gb          1290  
                                          model_forward         0.00%       3.892ms        15.79%       52.048s        5.205s       0.000us         0.00%       54.805s        5.481s     163.45 Kb      -1.44 Mb       5.47 Gb    -288.00 Mb            10  
                CheckpointFunctionEndWithFlashAttention         0.77%        2.541s        15.62%       51.471s     160.846ms     553.647ms         0.12%       53.156s     166.113ms       1.55 Mb       1.55 Mb       1.27 Gb      -1.91 Gb           320  
-------------------------------------------------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  
Self CPU time total: 329.590s
Self CUDA time total: 478.956s

-------------------------------------------------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  
                                                   Name    Self CPU %      Self CPU   CPU total %     CPU total  CPU time avg     Self CUDA   Self CUDA %    CUDA total  CUDA time avg       CPU Mem  Self CPU Mem      CUDA Mem  Self CUDA Mem    # of Calls  
-------------------------------------------------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  
                                     record_param_comms         0.15%     505.637ms         0.25%     819.445ms      63.820us      177.151s        37.19%      183.995s      14.330ms           0 b           0 b           0 b           0 b         12840  
autograd::engine::evaluate_function: CheckpointFunct...         0.00%      11.924ms        41.65%      137.279s     428.996ms       0.000us         0.00%      165.627s     517.585ms           0 b           0 b      29.24 Gb      -1.86 Gb           320  
        CheckpointFunctionEndWithFlashAttentionBackward         0.31%        1.032s        41.64%      137.267s     428.959ms        1.887s         0.40%      165.627s     517.585ms           0 b     -10.00 Kb      31.10 Gb     -11.59 Gb           320  
                       FullyShardedDataParallel.forward         0.26%     844.486ms        29.37%       96.809s      75.045ms       0.000us         0.00%      155.538s     120.572ms       1.60 Mb          -8 b      23.47 Gb     -43.70 Gb          1290  
                                 c10d::_allgather_base_         0.01%      35.667ms         0.16%     543.188ms     281.445us       0.000us         0.00%      134.134s      69.500ms           0 b           0 b           0 b           0 b          1930  
ncclDevKernel_AllGather_RING_LL(ncclDevComm*, unsign...         0.00%       0.000us         0.00%       0.000us       0.000us      131.126s        27.53%      131.126s      67.941ms           0 b           0 b           0 b           0 b          1930  
                                  nccl:_all_gather_base         0.00%       0.000us         0.00%       0.000us       0.000us      131.126s        27.53%      131.126s      67.941ms           0 b           0 b           0 b           0 b          1930  
                  FullyShardedDataParallel._pre_forward         0.34%        1.118s        12.67%       41.771s      32.380ms       0.000us         0.00%       89.874s      69.670ms           0 b           0 b     487.40 Gb     487.40 Gb          1290  
                                          model_forward         0.00%       3.937ms        15.80%       52.098s        5.210s       0.000us         0.00%       53.961s        5.396s     163.45 Kb      -1.44 Mb       5.47 Gb    -288.00 Mb            10  
                CheckpointFunctionEndWithFlashAttention         1.00%        3.289s        15.62%       51.482s     160.881ms     618.436ms         0.13%       52.238s     163.244ms       1.55 Mb       1.55 Mb       1.27 Gb      -1.90 Gb           320  
-------------------------------------------------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  
Self CPU time total: 329.632s
Self CUDA time total: 476.332s

-------------------------------------------------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  
                                                   Name    Self CPU %      Self CPU   CPU total %     CPU total  CPU time avg     Self CUDA   Self CUDA %    CUDA total  CUDA time avg       CPU Mem  Self CPU Mem      CUDA Mem  Self CUDA Mem    # of Calls  
-------------------------------------------------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  
                                     record_param_comms         0.16%     510.971ms         0.25%     822.870ms      53.433us      177.873s        37.16%      185.292s      12.032ms           0 b           0 b           0 b           0 b         15400  
autograd::engine::evaluate_function: CheckpointFunct...         0.00%      11.820ms        41.69%      137.420s     429.437ms       0.000us         0.00%      163.949s     512.342ms           0 b           0 b      29.24 Gb      -1.86 Gb           320  
        CheckpointFunctionEndWithFlashAttentionBackward         0.30%     998.438ms        41.69%      137.408s     429.400ms        2.009s         0.42%      163.949s     512.342ms           0 b     -10.00 Kb      31.10 Gb     -10.42 Gb           320  
                       FullyShardedDataParallel.forward         0.25%     836.759ms        29.54%       97.353s      75.467ms       0.000us         0.00%      158.450s     122.830ms       1.60 Mb           0 b      23.61 Gb     -43.70 Gb          1290  
                                 c10d::_allgather_base_         0.01%      36.518ms         0.16%     522.870ms     270.917us       0.000us         0.00%      134.515s      69.697ms           0 b           0 b           0 b           0 b          1930  
ncclDevKernel_AllGather_RING_LL(ncclDevComm*, unsign...         0.00%       0.000us         0.00%       0.000us       0.000us      131.848s        27.55%      131.848s      68.315ms           0 b           0 b           0 b           0 b          1930  
                                  nccl:_all_gather_base         0.00%       0.000us         0.00%       0.000us       0.000us      131.848s        27.55%      131.848s      68.315ms           0 b           0 b           0 b           0 b          1930  
                  FullyShardedDataParallel._pre_forward         0.34%        1.122s        12.66%       41.717s      32.338ms       0.000us         0.00%       91.230s      70.721ms           0 b           0 b     487.40 Gb     487.40 Gb          1290  
                                          model_forward         0.00%       4.089ms        15.80%       52.066s        5.207s       0.000us         0.00%       56.720s        5.672s     163.45 Kb      -1.44 Mb       5.46 Gb    -285.00 Mb            10  
                CheckpointFunctionEndWithFlashAttention         0.79%        2.612s        15.62%       51.475s     160.860ms     803.055ms         0.17%       54.941s     171.692ms       1.55 Mb       1.55 Mb       1.27 Gb      -2.54 Gb           320  
-------------------------------------------------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  
Self CPU time total: 329.597s
Self CUDA time total: 478.658s

-------------------------------------------------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  
                                                   Name    Self CPU %      Self CPU   CPU total %     CPU total  CPU time avg     Self CUDA   Self CUDA %    CUDA total  CUDA time avg       CPU Mem  Self CPU Mem      CUDA Mem  Self CUDA Mem    # of Calls  
-------------------------------------------------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  
                                     record_param_comms         0.20%     674.959ms         0.30%     982.489ms      63.798us      177.315s        37.06%      184.834s      12.002ms           0 b           0 b           0 b           0 b         15400  
autograd::engine::evaluate_function: CheckpointFunct...         0.00%      14.570ms        41.63%      137.280s     428.999ms       0.000us         0.00%      163.580s     511.188ms           0 b           0 b      29.24 Gb      -1.86 Gb           320  
        CheckpointFunctionEndWithFlashAttentionBackward         0.37%        1.224s        41.63%      137.265s     428.952ms        1.951s         0.41%      163.512s     510.974ms           0 b     -10.00 Kb      31.10 Gb     -11.66 Gb           320  
                       FullyShardedDataParallel.forward         0.25%     836.770ms        29.54%       97.412s      75.513ms       0.000us         0.00%      157.814s     122.336ms       1.60 Mb           8 b      23.44 Gb     -43.64 Gb          1290  
                                 c10d::_allgather_base_         0.01%      36.369ms         0.20%     675.140ms     349.813us       0.000us         0.00%      134.410s      69.643ms           0 b           0 b           0 b           0 b          1930  
ncclDevKernel_AllGather_RING_LL(ncclDevComm*, unsign...         0.00%       0.000us         0.00%       0.000us       0.000us      131.276s        27.44%      131.276s      68.019ms           0 b           0 b           0 b           0 b          1930  
                                  nccl:_all_gather_base         0.00%       0.000us         0.00%       0.000us       0.000us      131.276s        27.44%      131.276s      68.019ms           0 b           0 b           0 b           0 b          1930  
                  FullyShardedDataParallel._pre_forward         0.34%        1.130s        12.75%       42.041s      32.590ms       0.000us         0.00%       90.451s      70.117ms           0 b           0 b     487.40 Gb     487.03 Gb          1290  
                                          model_forward         0.00%       3.709ms        15.84%       52.237s        5.224s       0.000us         0.00%       55.793s        5.579s     163.45 Kb      -1.44 Mb       5.47 Gb    -288.00 Mb            10  
                CheckpointFunctionEndWithFlashAttention         0.94%        3.111s        15.61%       51.490s     160.907ms     905.470ms         0.19%       54.154s     169.231ms       1.55 Mb       1.55 Mb       1.27 Gb      -1.90 Gb           320  
-------------------------------------------------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  
Self CPU time total: 329.751s
Self CUDA time total: 478.422s

{'Latency (seconds)': 2772.0640410000005, 'Bandwidth (GiB per second)': 1.013911185428959}
{'Latency (seconds)': 2772.9628109999994, 'Bandwidth (GiB per second)': 1.0120727649886434}
{'Latency (seconds)': 2772.9397329999983, 'Bandwidth (GiB per second)': 1.0138322543241483}
{'Latency (seconds)': 2775.9623490000004, 'Bandwidth (GiB per second)': 1.0120585057457991}
