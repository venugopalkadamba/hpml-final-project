python3 -m torch.distributed.run --nproc_per_node=4          llama2/LightSeq/lightseq/twp_v1.py         --model_name_or_path meta-llama/Llama-2-7b-hf         --data_path data_llama2.pkl        --bf16         --output_dir outputs         --num_train_epochs 3            --per_device_train_batch_size 1         --per_device_eval_batch_size 1          --gradient_accumulation_steps 1         --evaluation_strategy no         --save_strategy steps         --save_steps 1000          --save_total_limit 1         --learning_rate 2e-5         --weight_decay 0.          --warmup_ratio 0.03          --lr_scheduler_type "cosine"         --logging_steps 1          --fsdp "full_shard auto_wrap"         --fsdp_transformer_layer_cls_to_wrap 'LlamaDecoderLayer'         --tf32 True          --model_max_length 512          --gradient_checkpointing True          --lazy_preprocess True > meta_Llama_2_1B_length_512.txt


Initializing Torch distributed.
************ Finish sequence pralell group Initialization. ***********
torch distributed is already initialized, skipping initialization ...
trainable params 6738415616
trainable params 6738415616
trainable params 6738415616
trainable params 6738415616
Initializing global memoery buffer.
Initializing global memoery buffer for backward.
Cumulated time list [18.515267372131348]
Cumulated time list [18.515883684158325]
Cumulated time list [18.51769232749939]
Cumulated time list [18.518061637878418]
Cumulated time list [18.51769232749939, 18.945821523666382]Cumulated time list [18.515267372131348, 18.948625326156616]Cumulated time list [18.515883684158325, 18.947882890701294]


Cumulated time list [18.518061637878418, 18.94598913192749]
Cumulated time list [18.51769232749939, 18.945821523666382, 18.940553903579712]
Cumulated time list [18.515267372131348, 18.948625326156616, 18.940793991088867]
Cumulated time list [18.518061637878418, 18.94598913192749, 18.941277980804443]
Cumulated time list [18.515883684158325, 18.947882890701294, 18.941756010055542]
Cumulated time list [18.518061637878418, 18.94598913192749, 18.941277980804443, 18.943161010742188]
Cumulated time list [18.515883684158325, 18.947882890701294, 18.941756010055542, 18.94284200668335]
Cumulated time list [18.51769232749939, 18.945821523666382, 18.940553903579712, 18.944023370742798]
Cumulated time list [18.515267372131348, 18.948625326156616, 18.940793991088867, 18.943912029266357]
Cumulated time list [18.515883684158325, 18.947882890701294, 18.941756010055542, 18.94284200668335, 18.94787073135376]Cumulated time list [18.515267372131348, 18.948625326156616, 18.940793991088867, 18.943912029266357, 18.94778037071228]

Cumulated time list [18.518061637878418, 18.94598913192749, 18.941277980804443, 18.943161010742188, 18.94971776008606]
Cumulated time list [18.51769232749939, 18.945821523666382, 18.940553903579712, 18.944023370742798, 18.95216941833496]
Cumulated time list [18.51769232749939, 18.945821523666382, 18.940553903579712, 18.944023370742798, 18.95216941833496, 18.932320833206177]Cumulated time list [18.518061637878418, 18.94598913192749, 18.941277980804443, 18.943161010742188, 18.94971776008606, 18.934837102890015]

Cumulated time list [18.515883684158325, 18.947882890701294, 18.941756010055542, 18.94284200668335, 18.94787073135376, 18.936618089675903]
Cumulated time list [18.515267372131348, 18.948625326156616, 18.940793991088867, 18.943912029266357, 18.94778037071228, 18.94101071357727]
Cumulated time list [18.51769232749939, 18.945821523666382, 18.940553903579712, 18.944023370742798, 18.95216941833496, 18.932320833206177, 18.923635244369507]
Cumulated time list [18.515267372131348, 18.948625326156616, 18.940793991088867, 18.943912029266357, 18.94778037071228, 18.94101071357727, 18.91919255256653]
Cumulated time list [18.515883684158325, 18.947882890701294, 18.941756010055542, 18.94284200668335, 18.94787073135376, 18.936618089675903, 18.92372488975525]
Cumulated time list [18.518061637878418, 18.94598913192749, 18.941277980804443, 18.943161010742188, 18.94971776008606, 18.934837102890015, 18.92449188232422]
Cumulated time list [18.518061637878418, 18.94598913192749, 18.941277980804443, 18.943161010742188, 18.94971776008606, 18.934837102890015, 18.92449188232422, 18.934652090072632]Cumulated time list [18.515883684158325, 18.947882890701294, 18.941756010055542, 18.94284200668335, 18.94787073135376, 18.936618089675903, 18.92372488975525, 18.935458660125732]Cumulated time list [18.51769232749939, 18.945821523666382, 18.940553903579712, 18.944023370742798, 18.95216941833496, 18.932320833206177, 18.923635244369507, 18.935545682907104]


Cumulated time list [18.515267372131348, 18.948625326156616, 18.940793991088867, 18.943912029266357, 18.94778037071228, 18.94101071357727, 18.91919255256653, 18.935681343078613]
Cumulated time list [18.518061637878418, 18.94598913192749, 18.941277980804443, 18.943161010742188, 18.94971776008606, 18.934837102890015, 18.92449188232422, 18.934652090072632, 18.93763828277588]Cumulated time list [18.515267372131348, 18.948625326156616, 18.940793991088867, 18.943912029266357, 18.94778037071228, 18.94101071357727, 18.91919255256653, 18.935681343078613, 18.937587022781372]Cumulated time list [18.51769232749939, 18.945821523666382, 18.940553903579712, 18.944023370742798, 18.95216941833496, 18.932320833206177, 18.923635244369507, 18.935545682907104, 18.937651872634888]


Cumulated time list [18.515883684158325, 18.947882890701294, 18.941756010055542, 18.94284200668335, 18.94787073135376, 18.936618089675903, 18.92372488975525, 18.935458660125732, 18.93990421295166]
Per GPU shape: torch.Size([1, 512]), 18892.157130771215 ms, 132.62056054046178 ms
Per GPU shape: torch.Size([1, 512]), 18892.437908384534 ms, 133.3114460196542 ms
Per GPU shape: torch.Size([1, 512]), 18892.20298661126 ms, 132.46142242820446 ms
Per GPU shape: torch.Size([1, 512]), 18892.205635706585 ms, 133.52003733695545 ms
-------------------------------------------------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  
                                                   Name    Self CPU %      Self CPU   CPU total %     CPU total  CPU time avg     Self CUDA   Self CUDA %    CUDA total  CUDA time avg       CPU Mem  Self CPU Mem      CUDA Mem  Self CUDA Mem    # of Calls  
-------------------------------------------------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  
                                     record_param_comms         0.71%        2.375s         0.80%        2.682s     208.891us      178.339s        36.24%      184.340s      14.357ms           0 b           0 b           0 b           0 b         12840  
autograd::engine::evaluate_function: CheckpointFunct...         0.00%      11.663ms        41.39%      138.465s     432.704ms       0.000us         0.00%      172.243s     538.259ms           0 b           0 b      29.27 Gb      -3.69 Gb           320  
        CheckpointFunctionEndWithFlashAttentionBackward         0.29%     982.905ms        41.39%      138.454s     432.667ms        5.066s         1.03%      172.243s     538.259ms           0 b      -9.98 Kb      32.96 Gb     -20.15 Gb           320  
                       FullyShardedDataParallel.forward         0.25%     831.295ms        30.01%      100.400s      77.830ms       0.000us         0.00%      160.212s     124.196ms       1.60 Mb           0 b      41.46 Gb     -87.22 Gb          1290  
                                 c10d::_allgather_base_         0.01%      35.681ms         0.72%        2.407s       1.247ms       0.000us         0.00%      134.510s      69.694ms           0 b           0 b           0 b           0 b          1930  
ncclDevKernel_AllGather_RING_LL(ncclDevComm*, unsign...         0.00%       0.000us         0.00%       0.000us       0.000us      132.044s        26.83%      132.044s      68.417ms           0 b           0 b           0 b           0 b          1930  
                                  nccl:_all_gather_base         0.00%       0.000us         0.00%       0.000us       0.000us      132.044s        26.83%      132.044s      68.417ms           0 b           0 b           0 b           0 b          1930  
                  FullyShardedDataParallel._pre_forward         0.32%        1.087s        13.16%       44.035s      34.136ms       0.000us         0.00%       90.631s      70.257ms           0 b           0 b     487.40 Gb     487.40 Gb          1290  
                                          model_forward         0.00%       3.880ms        16.31%       54.551s        5.455s       0.000us         0.00%       56.217s        5.622s     163.45 Kb      -1.44 Mb       6.02 Gb    -562.50 Mb            10  
                CheckpointFunctionEndWithFlashAttention         0.78%        2.600s        15.57%       52.076s     162.737ms        1.166s         0.24%       54.616s     170.675ms       1.55 Mb       1.55 Mb       2.52 Gb      -3.50 Gb           320  
-------------------------------------------------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  
Self CPU time total: 334.509s
Self CUDA time total: 492.074s

-------------------------------------------------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  
                                                   Name    Self CPU %      Self CPU   CPU total %     CPU total  CPU time avg     Self CUDA   Self CUDA %    CUDA total  CUDA time avg       CPU Mem  Self CPU Mem      CUDA Mem  Self CUDA Mem    # of Calls  
-------------------------------------------------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  
                                     record_param_comms         0.13%     442.900ms         0.23%     754.010ms      58.724us      177.237s        36.27%      182.813s      14.238ms           0 b           0 b           0 b           0 b         12840  
autograd::engine::evaluate_function: CheckpointFunct...         0.00%      11.431ms        41.63%      138.465s     432.704ms       0.000us         0.00%      171.696s     536.551ms           0 b           0 b      29.27 Gb      -3.69 Gb           320  
        CheckpointFunctionEndWithFlashAttentionBackward         0.30%     988.547ms        41.63%      138.454s     432.668ms        4.835s         0.99%      171.696s     536.551ms           0 b      -9.95 Kb      32.96 Gb     -22.64 Gb           320  
                       FullyShardedDataParallel.forward         0.25%     828.152ms        29.38%       97.717s      75.749ms       0.000us         0.00%      157.065s     121.756ms       1.60 Mb          -8 b      41.46 Gb     -87.38 Gb          1290  
                                 c10d::_allgather_base_         0.01%      35.682ms         0.15%     487.658ms     252.673us       0.000us         0.00%      132.906s      68.863ms           0 b           0 b           0 b           0 b          1930  
ncclDevKernel_AllGather_RING_LL(ncclDevComm*, unsign...         0.00%       0.000us         0.00%       0.000us       0.000us      130.951s        26.80%      130.951s      67.850ms           0 b           0 b           0 b           0 b          1930  
                                  nccl:_all_gather_base         0.00%       0.000us         0.00%       0.000us       0.000us      130.951s        26.80%      130.951s      67.850ms           0 b           0 b           0 b           0 b          1930  
                  FullyShardedDataParallel._pre_forward         0.33%        1.105s        12.67%       42.147s      32.672ms       0.000us         0.00%       89.477s      69.362ms           0 b           0 b     487.40 Gb     487.40 Gb          1290  
                                          model_forward         0.00%       3.937ms        15.83%       52.644s        5.264s       0.000us         0.00%       55.096s        5.510s     163.45 Kb      -1.44 Mb       6.02 Gb    -562.50 Mb            10  
                CheckpointFunctionEndWithFlashAttention         1.05%        3.497s        15.66%       52.090s     162.781ms        1.279s         0.26%       53.433s     166.977ms       1.55 Mb       1.55 Mb       2.52 Gb      -3.54 Gb           320  
-------------------------------------------------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  
Self CPU time total: 332.579s
Self CUDA time total: 488.660s

-------------------------------------------------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  
                                                   Name    Self CPU %      Self CPU   CPU total %     CPU total  CPU time avg     Self CUDA   Self CUDA %    CUDA total  CUDA time avg       CPU Mem  Self CPU Mem      CUDA Mem  Self CUDA Mem    # of Calls  
-------------------------------------------------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  
                                     record_param_comms         0.75%        2.508s         0.84%        2.818s     182.967us      178.007s        36.17%      185.470s      12.043ms           0 b           0 b           0 b           0 b         15400  
autograd::engine::evaluate_function: CheckpointFunct...         0.00%      11.327ms        41.42%      138.595s     433.110ms       0.000us         0.00%      171.790s     536.842ms           0 b           0 b      29.26 Gb      -3.70 Gb           320  
        CheckpointFunctionEndWithFlashAttentionBackward         0.30%     992.632ms        41.42%      138.584s     433.075ms        4.912s         1.00%      171.790s     536.842ms           0 b     -10.00 Kb      32.96 Gb     -20.03 Gb           320  
                       FullyShardedDataParallel.forward         0.25%     837.608ms        29.95%      100.201s      77.676ms       0.000us         0.00%      163.387s     126.657ms       1.60 Mb          -8 b      41.50 Gb     -86.97 Gb          1290  
                                 c10d::_allgather_base_         0.01%      35.619ms         0.75%        2.507s       1.299ms       0.000us         0.00%      134.356s      69.614ms           0 b           0 b           0 b           0 b          1930  
ncclDevKernel_AllGather_RING_LL(ncclDevComm*, unsign...         0.00%       0.000us         0.00%       0.000us       0.000us      131.706s        26.76%      131.706s      68.241ms           0 b           0 b           0 b           0 b          1930  
                                  nccl:_all_gather_base         0.00%       0.000us         0.00%       0.000us       0.000us      131.706s        26.76%      131.706s      68.241ms           0 b           0 b           0 b           0 b          1930  
                  FullyShardedDataParallel._pre_forward         0.33%        1.099s        13.15%       43.998s      34.107ms       0.000us         0.00%       90.279s      69.984ms           0 b           0 b     487.40 Gb     487.40 Gb          1290  
                                          model_forward         0.00%       4.092ms        16.33%       54.657s        5.466s       0.000us         0.00%       59.005s        5.900s     163.45 Kb      -1.44 Mb       6.02 Gb    -562.50 Mb            10  
                CheckpointFunctionEndWithFlashAttention         0.84%        2.824s        15.56%       52.078s     162.745ms        1.993s         0.40%       57.148s     178.589ms       1.55 Mb       1.55 Mb       2.53 Gb      -4.39 Gb           320  
-------------------------------------------------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  
Self CPU time total: 334.613s
Self CUDA time total: 492.114s

-------------------------------------------------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  
                                                   Name    Self CPU %      Self CPU   CPU total %     CPU total  CPU time avg     Self CUDA   Self CUDA %    CUDA total  CUDA time avg       CPU Mem  Self CPU Mem      CUDA Mem  Self CUDA Mem    # of Calls  
-------------------------------------------------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  
                                     record_param_comms         0.64%        2.135s         0.73%        2.441s     158.529us      177.362s        35.94%      184.336s      11.970ms           0 b           0 b           0 b           0 b         15400  
autograd::engine::evaluate_function: CheckpointFunct...         0.00%      12.228ms        41.43%      138.467s     432.709ms       0.000us         0.00%      169.909s     530.967ms           0 b           0 b      29.27 Gb      -3.69 Gb           320  
        CheckpointFunctionEndWithFlashAttentionBackward         0.30%        1.002s        41.43%      138.454s     432.670ms        4.971s         1.01%      169.907s     530.960ms           0 b      -9.97 Kb      32.96 Gb     -22.44 Gb           320  
                       FullyShardedDataParallel.forward         0.25%     833.217ms        29.85%       99.771s      77.342ms       0.000us         0.00%      157.600s     122.171ms       1.60 Mb           0 b      41.43 Gb     -87.28 Gb          1290  
                                 c10d::_allgather_base_         0.01%      36.483ms         0.64%        2.138s       1.108ms       0.000us         0.00%      132.951s      68.887ms           0 b           0 b           0 b           0 b          1930  
ncclDevKernel_AllGather_RING_LL(ncclDevComm*, unsign...         0.00%       0.000us         0.00%       0.000us       0.000us      131.084s        26.56%      131.084s      67.919ms           0 b           0 b           0 b           0 b          1930  
                                  nccl:_all_gather_base         0.00%       0.000us         0.00%       0.000us       0.000us      131.084s        26.56%      131.084s      67.919ms           0 b           0 b           0 b           0 b          1930  
                  FullyShardedDataParallel._pre_forward         0.34%        1.126s        13.11%       43.833s      33.979ms       0.000us         0.00%       89.208s      69.154ms           0 b           0 b     487.40 Gb     487.40 Gb          1290  
                                          model_forward         0.00%       3.766ms        16.24%       54.290s        5.429s       0.000us         0.00%       56.819s        5.682s     163.45 Kb      -1.44 Mb       6.02 Gb    -562.50 Mb            10  
                CheckpointFunctionEndWithFlashAttention         1.00%        3.342s        15.59%       52.090s     162.782ms        2.186s         0.44%       55.160s     172.374ms       1.55 Mb       1.55 Mb       2.52 Gb      -3.79 Gb           320  
-------------------------------------------------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  
Self CPU time total: 334.219s
Self CUDA time total: 493.486s

{'Latency (seconds)': 2843.2594659999995, 'Bandwidth (GiB per second)': 1.1166568484375403}
{'Latency (seconds)': 2818.483476999998, 'Bandwidth (GiB per second)': 1.1222902291331769}
{'Latency (seconds)': 2828.0606470000016, 'Bandwidth (GiB per second)': 1.124954312144995}
{'Latency (seconds)': 2858.675189, 'Bandwidth (GiB per second)': 1.1099002045881552}
