python3 -m torch.distributed.run --nproc_per_node=4          llama2/LightSeq/lightseq/twp_v1.py         --model_name_or_path meta-llama/Llama-2-7b-hf         --data_path data_llama2.pkl        --bf16         --output_dir outputs         --num_train_epochs 3            --per_device_train_batch_size 1         --per_device_eval_batch_size 1          --gradient_accumulation_steps 1         --evaluation_strategy no         --save_strategy steps         --save_steps 1000          --save_total_limit 1         --learning_rate 2e-5         --weight_decay 0.          --warmup_ratio 0.03          --lr_scheduler_type "cosine"         --logging_steps 1          --fsdp "full_shard auto_wrap"         --fsdp_transformer_layer_cls_to_wrap 'LlamaDecoderLayer'         --tf32 True          --model_max_length 1024          --gradient_checkpointing True          --lazy_preprocess True > meta_Llama_2_1B_length_1024.txt



Initializing Torch distributed.
************ Finish sequence pralell group Initialization. ***********
trainable params 6738415616
trainable params 6738415616
torch distributed is already initialized, skipping initialization ...
trainable params 6738415616
trainable params 6738415616
Initializing global memoery buffer.
Initializing global memoery buffer for backward.
Cumulated time list [18.9057674407959]
Cumulated time list [18.907814025878906]
Cumulated time list [18.907636404037476]
Cumulated time list [18.908602237701416]
Cumulated time list [18.907636404037476, 19.335213899612427]
Cumulated time list [18.907814025878906, 19.33530020713806]
Cumulated time list [18.908602237701416, 19.334467887878418]
Cumulated time list [18.9057674407959, 19.337401151657104]
Cumulated time list [18.9057674407959, 19.337401151657104, 19.343134880065918]
Cumulated time list [18.907814025878906, 19.33530020713806, 19.3436062335968]
Cumulated time list [18.907636404037476, 19.335213899612427, 19.343695878982544]
Cumulated time list [18.908602237701416, 19.334467887878418, 19.345685482025146]
Cumulated time list [18.907814025878906, 19.33530020713806, 19.3436062335968, 19.360615015029907]
Cumulated time list [18.9057674407959, 19.337401151657104, 19.343134880065918, 19.36097478866577]
Cumulated time list [18.907636404037476, 19.335213899612427, 19.343695878982544, 19.36294651031494]
Cumulated time list [18.908602237701416, 19.334467887878418, 19.345685482025146, 19.362135648727417]
Cumulated time list [18.9057674407959, 19.337401151657104, 19.343134880065918, 19.36097478866577, 19.366098165512085]
Cumulated time list [18.907636404037476, 19.335213899612427, 19.343695878982544, 19.36294651031494, 19.3639395236969]
Cumulated time list [18.908602237701416, 19.334467887878418, 19.345685482025146, 19.362135648727417, 19.362700700759888]
Cumulated time list [18.907814025878906, 19.33530020713806, 19.3436062335968, 19.360615015029907, 19.368608474731445]
Cumulated time list [18.907814025878906, 19.33530020713806, 19.3436062335968, 19.360615015029907, 19.368608474731445, 19.34328603744507]
Cumulated time list [18.9057674407959, 19.337401151657104, 19.343134880065918, 19.36097478866577, 19.366098165512085, 19.345797300338745]Cumulated time list [18.907636404037476, 19.335213899612427, 19.343695878982544, 19.36294651031494, 19.3639395236969, 19.34563660621643]

Cumulated time list [18.908602237701416, 19.334467887878418, 19.345685482025146, 19.362135648727417, 19.362700700759888, 19.345666646957397]
Cumulated time list [18.907814025878906, 19.33530020713806, 19.3436062335968, 19.360615015029907, 19.368608474731445, 19.34328603744507, 19.35126495361328]
Cumulated time list [18.907636404037476, 19.335213899612427, 19.343695878982544, 19.36294651031494, 19.3639395236969, 19.34563660621643, 19.351343631744385]
Cumulated time list [18.908602237701416, 19.334467887878418, 19.345685482025146, 19.362135648727417, 19.362700700759888, 19.345666646957397, 19.351680994033813]
Cumulated time list [18.9057674407959, 19.337401151657104, 19.343134880065918, 19.36097478866577, 19.366098165512085, 19.345797300338745, 19.354849576950073]
Cumulated time list [18.9057674407959, 19.337401151657104, 19.343134880065918, 19.36097478866577, 19.366098165512085, 19.345797300338745, 19.354849576950073, 19.332069158554077]
Cumulated time list [18.907636404037476, 19.335213899612427, 19.343695878982544, 19.36294651031494, 19.3639395236969, 19.34563660621643, 19.351343631744385, 19.336036443710327]
Cumulated time list [18.907814025878906, 19.33530020713806, 19.3436062335968, 19.360615015029907, 19.368608474731445, 19.34328603744507, 19.35126495361328, 19.336289644241333]
Cumulated time list [18.908602237701416, 19.334467887878418, 19.345685482025146, 19.362135648727417, 19.362700700759888, 19.345666646957397, 19.351680994033813, 19.338401556015015]
Cumulated time list [18.9057674407959, 19.337401151657104, 19.343134880065918, 19.36097478866577, 19.366098165512085, 19.345797300338745, 19.354849576950073, 19.332069158554077, 19.335429906845093]Cumulated time list [18.907814025878906, 19.33530020713806, 19.3436062335968, 19.360615015029907, 19.368608474731445, 19.34328603744507, 19.35126495361328, 19.336289644241333, 19.334826469421387]

Cumulated time list [18.908602237701416, 19.334467887878418, 19.345685482025146, 19.362135648727417, 19.362700700759888, 19.345666646957397, 19.351680994033813, 19.338401556015015, 19.332367658615112]
Cumulated time list [18.907636404037476, 19.335213899612427, 19.343695878982544, 19.36294651031494, 19.3639395236969, 19.34563660621643, 19.351343631744385, 19.336036443710327, 19.335235595703125]
Per GPU shape: torch.Size([1, 1024]), 19297.94692993164 ms, 139.09122077338716 ms
Per GPU shape: torch.Size([1, 1024]), 19297.956784566242 ms, 138.3766095264264 ms
Per GPU shape: torch.Size([1, 1024]), 19297.96494377984 ms, 138.39188865005175 ms
Per GPU shape: torch.Size([1, 1024]), 19297.96764585707 ms, 138.0423292812586 ms
-------------------------------------------------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  
                                                   Name    Self CPU %      Self CPU   CPU total %     CPU total  CPU time avg     Self CUDA   Self CUDA %    CUDA total  CUDA time avg       CPU Mem  Self CPU Mem      CUDA Mem  Self CUDA Mem    # of Calls  
-------------------------------------------------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  
                                     record_param_comms         0.66%        2.247s         0.75%        2.557s     199.141us      179.444s        35.19%      186.858s      14.553ms           0 b           0 b           0 b           0 b         12840  
autograd::engine::evaluate_function: CheckpointFunct...         0.00%      11.969ms        41.42%      140.990s     440.594ms       0.000us         0.00%      182.112s     569.101ms           0 b           0 b      29.32 Gb      -7.38 Gb           320  
        CheckpointFunctionEndWithFlashAttentionBackward         0.30%        1.013s        41.41%      140.978s     440.557ms        7.800s         1.53%      182.112s     569.101ms           0 b     -10.00 Kb      36.70 Gb     -40.87 Gb           320  
                       FullyShardedDataParallel.forward         0.24%     832.619ms        30.12%      102.525s      79.477ms       0.000us         0.00%      166.321s     128.931ms       1.60 Mb           0 b      77.95 Gb    -173.84 Gb          1290  
                                 c10d::_allgather_base_         0.01%      37.553ms         0.67%        2.279s       1.181ms       0.000us         0.00%      136.838s      70.900ms           0 b           0 b           0 b           0 b          1930  
ncclDevKernel_AllGather_RING_LL(ncclDevComm*, unsign...         0.00%       0.000us         0.00%       0.000us       0.000us      133.286s        26.14%      133.286s      69.060ms           0 b           0 b           0 b           0 b          1930  
                                  nccl:_all_gather_base         0.00%       0.000us         0.00%       0.000us       0.000us      133.286s        26.14%      133.286s      69.060ms           0 b           0 b           0 b           0 b          1930  
                  FullyShardedDataParallel._pre_forward         0.33%        1.109s        13.17%       44.825s      34.748ms       0.000us         0.00%       91.436s      70.881ms           0 b           0 b     487.40 Gb     487.40 Gb          1290  
                                          model_forward         0.00%       3.830ms        16.40%       55.839s        5.584s       0.000us         0.00%       58.977s        5.898s     163.45 Kb      -1.44 Mb       7.15 Gb      -1.10 Gb            10  
                CheckpointFunctionEndWithFlashAttention         0.76%        2.581s        15.71%       53.482s     167.130ms        2.595s         0.51%       57.180s     178.689ms       1.55 Mb       1.55 Mb       5.03 Gb      -7.58 Gb           320  
-------------------------------------------------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  
Self CPU time total: 340.432s
Self CUDA time total: 509.969s

-------------------------------------------------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  
                                                   Name    Self CPU %      Self CPU   CPU total %     CPU total  CPU time avg     Self CUDA   Self CUDA %    CUDA total  CUDA time avg       CPU Mem  Self CPU Mem      CUDA Mem  Self CUDA Mem    # of Calls  
-------------------------------------------------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  
                                     record_param_comms         0.65%        2.219s         0.74%        2.535s     197.407us      178.396s        35.21%      184.638s      14.380ms           0 b           0 b           0 b           0 b         12840  
autograd::engine::evaluate_function: CheckpointFunct...         0.00%      11.838ms        41.42%      140.992s     440.600ms       0.000us         0.00%      179.117s     559.742ms           0 b           0 b      29.32 Gb      -7.38 Gb           320  
        CheckpointFunctionEndWithFlashAttentionBackward         0.30%        1.028s        41.41%      140.980s     440.563ms        7.620s         1.50%      179.117s     559.742ms           0 b     -10.00 Kb      36.70 Gb     -45.77 Gb           320  
                       FullyShardedDataParallel.forward         0.25%     836.210ms        29.89%      101.736s      78.865ms       0.000us         0.00%      164.598s     127.595ms       1.60 Mb           0 b      77.90 Gb    -173.80 Gb          1290  
                                 c10d::_allgather_base_         0.01%      36.366ms         0.66%        2.256s       1.169ms       0.000us         0.00%      134.761s      69.825ms           0 b           0 b           0 b           0 b          1930  
ncclDevKernel_AllGather_RING_LL(ncclDevComm*, unsign...         0.00%       0.000us         0.00%       0.000us       0.000us      132.253s        26.11%      132.253s      68.525ms           0 b           0 b           0 b           0 b          1930  
                                  nccl:_all_gather_base         0.00%       0.000us         0.00%       0.000us       0.000us      132.253s        26.11%      132.253s      68.525ms           0 b           0 b           0 b           0 b          1930  
                  FullyShardedDataParallel._pre_forward         0.33%        1.116s        13.13%       44.705s      34.655ms       0.000us         0.00%       90.701s      70.311ms           0 b           0 b     487.40 Gb     487.40 Gb          1290  
                                          model_forward         0.00%       3.865ms        16.40%       55.812s        5.581s       0.000us         0.00%       58.885s        5.889s     163.45 Kb      -1.44 Mb       7.15 Gb      -1.10 Gb            10  
                CheckpointFunctionEndWithFlashAttention         0.99%        3.383s        15.71%       53.486s     167.144ms        2.673s         0.53%       57.069s     178.341ms       1.55 Mb       1.55 Mb       5.03 Gb      -7.58 Gb           320  
-------------------------------------------------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  
Self CPU time total: 340.410s
Self CUDA time total: 506.608s

-------------------------------------------------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  
                                                   Name    Self CPU %      Self CPU   CPU total %     CPU total  CPU time avg     Self CUDA   Self CUDA %    CUDA total  CUDA time avg       CPU Mem  Self CPU Mem      CUDA Mem  Self CUDA Mem    # of Calls  
-------------------------------------------------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  
                                     record_param_comms         0.49%        1.655s         0.58%        1.978s     128.443us      179.228s        35.07%      185.880s      12.070ms           0 b           0 b           0 b           0 b         15400  
autograd::engine::evaluate_function: CheckpointFunct...         0.00%      11.489ms        41.49%      140.993s     440.602ms       0.000us         0.00%      178.399s     557.498ms           0 b           0 b      29.32 Gb      -7.38 Gb           320  
        CheckpointFunctionEndWithFlashAttentionBackward         0.30%        1.026s        41.49%      140.981s     440.566ms        7.605s         1.49%      178.399s     557.498ms           0 b     -10.00 Kb      36.70 Gb     -40.68 Gb           320  
                       FullyShardedDataParallel.forward         0.25%     834.006ms        29.97%      101.854s      78.957ms       0.000us         0.00%      169.824s     131.647ms       1.60 Mb           0 b      77.82 Gb    -173.56 Gb          1290  
                                 c10d::_allgather_base_         0.01%      37.829ms         0.49%        1.652s     855.808us       0.000us         0.00%      135.861s      70.394ms           0 b           0 b           0 b           0 b          1930  
ncclDevKernel_AllGather_RING_LL(ncclDevComm*, unsign...         0.00%       0.000us         0.00%       0.000us       0.000us      133.101s        26.04%      133.101s      68.964ms           0 b           0 b           0 b           0 b          1930  
                                  nccl:_all_gather_base         0.00%       0.000us         0.00%       0.000us       0.000us      133.101s        26.04%      133.101s      68.964ms           0 b           0 b           0 b           0 b          1930  
                  FullyShardedDataParallel._pre_forward         0.33%        1.109s        13.00%       44.165s      34.236ms       0.000us         0.00%       91.092s      70.614ms           0 b           0 b     487.40 Gb     487.40 Gb          1290  
                                          model_forward         0.00%       3.930ms        16.25%       55.202s        5.520s       0.000us         0.00%       62.993s        6.299s     163.45 Kb      -1.44 Mb       7.15 Gb      -1.10 Gb            10  
                CheckpointFunctionEndWithFlashAttention         0.79%        2.682s        15.74%       53.480s     167.125ms        4.107s         0.80%       61.180s     191.187ms       1.55 Mb       1.55 Mb       5.03 Gb     -10.16 Gb           320  
-------------------------------------------------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  
Self CPU time total: 339.804s
Self CUDA time total: 511.102s

-------------------------------------------------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  
                                                   Name    Self CPU %      Self CPU   CPU total %     CPU total  CPU time avg     Self CUDA   Self CUDA %    CUDA total  CUDA time avg       CPU Mem  Self CPU Mem      CUDA Mem  Self CUDA Mem    # of Calls  
-------------------------------------------------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  
                                     record_param_comms         0.15%     508.703ms         0.24%     816.855ms      53.043us      178.480s        34.71%      185.031s      12.015ms           0 b           0 b           0 b           0 b         15400  
autograd::engine::evaluate_function: CheckpointFunct...         0.00%      12.757ms        41.64%      140.994s     440.606ms       0.000us         0.00%      180.519s     564.123ms           0 b           0 b      29.32 Gb      -7.41 Gb           320  
        CheckpointFunctionEndWithFlashAttentionBackward         0.31%        1.050s        41.63%      140.981s     440.565ms        7.935s         1.54%      180.518s     564.118ms           0 b     -10.00 Kb      36.73 Gb     -45.61 Gb           320  
                       FullyShardedDataParallel.forward         0.26%     867.269ms        29.67%      100.461s      77.877ms       0.000us         0.00%      166.478s     129.053ms       1.60 Mb           0 b      77.92 Gb    -173.23 Gb          1290  
                                 c10d::_allgather_base_         0.01%      37.653ms         0.15%     497.458ms     257.750us       0.000us         0.00%      135.239s      70.072ms           0 b           0 b           0 b           0 b          1930  
ncclDevKernel_AllGather_RING_LL(ncclDevComm*, unsign...         0.00%       0.000us         0.00%       0.000us       0.000us      132.348s        25.74%      132.348s      68.574ms           0 b           0 b           0 b           0 b          1930  
                                  nccl:_all_gather_base         0.00%       0.000us         0.00%       0.000us       0.000us      132.348s        25.74%      132.348s      68.574ms           0 b           0 b           0 b           0 b          1930  
                  FullyShardedDataParallel._pre_forward         0.34%        1.156s        12.67%       42.912s      33.265ms       0.000us         0.00%       90.576s      70.214ms           0 b           0 b     487.40 Gb     487.40 Gb          1290  
                                          model_forward         0.00%       3.951ms        15.96%       54.050s        5.405s       0.000us         0.00%       60.578s        6.058s     163.45 Kb      -1.44 Mb       7.15 Gb      -1.10 Gb            10  
                CheckpointFunctionEndWithFlashAttention         0.96%        3.252s        15.79%       53.487s     167.146ms        4.393s         0.85%       58.582s     183.068ms       1.55 Mb       1.55 Mb       5.03 Gb      -7.58 Gb           320  
-------------------------------------------------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  
Self CPU time total: 338.637s
Self CUDA time total: 514.180s

{'Latency (seconds)': 2941.6738269999996, 'Bandwidth (GiB per second)': 1.3375918806331755}
{'Latency (seconds)': 2908.5534129999983, 'Bandwidth (GiB per second)': 1.3607585115235543}
{'Latency (seconds)': 2942.9275510000025, 'Bandwidth (GiB per second)': 1.3403862045700499}
{'Latency (seconds)': 2928.9660010000002, 'Bandwidth (GiB per second)': 1.3428429682283078}
